<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Вайб 2021 — Promo15</title>
  <meta name="description" content="Тот самый вайб 2021 года: приветствие, таймер с 01.01.2021, картинка и кнопка на канал. Плюс: регистрация/логин, профиль, и «Библиолетка» — галерея фото с лайками и комментариями." />
  <style>
  :root{ --bgImage: url('https://i.ibb.co/C30Q1x8C/photo-2025-08-21-20-05-42.jpg'); --ink:#e9edf1; --muted:#a7b0c0; --stroke:rgba(255,255,255,.10); --bgBrightness:1.25; --bgSaturate:1.1; --accent:#7aa2ff; --danger:#ff6b6b; --ok:#4dd4a5; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif; line-height:1.6;
    min-height:100dvh;
  }
  /* Фон */
  body::before{content:""; position:fixed; inset:0; background-image: var(--bgImage); background-position:center; background-repeat:no-repeat; background-size:cover; filter: brightness(var(--bgBrightness)) saturate(var(--bgSaturate)); z-index:-2}
  body::after{content:""; position:fixed; inset:0; background: radial-gradient(1200px 800px at 10% -20%, rgba(27,30,54,.35), rgba(15,18,33,.70)); z-index:-1}

  .wrap{max-width:1100px; margin:auto; padding:28px 18px 42px}
  header{padding:22px; background:rgba(255,255,255,.06); border:1px solid var(--stroke); border-radius:18px; backdrop-filter:blur(8px)}
  h1{margin:0 0 8px; font-size: clamp(28px, 5vw, 44px)}
  .greeting{white-space: pre-line; margin:0}
  .counter{display:flex; flex-wrap:wrap; gap:12px; margin-top:14px}
  .pill{padding:10px 14px; border-radius:999px; background:rgba(13,19,40,.85); border:1px solid var(--stroke)}

  /* Верхняя панель навигации */
  .topbar{display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:12px}
  .tabs{display:flex; gap:8px; flex-wrap:wrap}
  .tablink{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--ink); text-decoration:none; font-weight:700; cursor:pointer}
  .tablink:hover{box-shadow:0 6px 16px rgba(0,0,0,.35)}

  /* Профиль/вход */
  .authbox{display:flex; align-items:center; gap:10px}
  .avatar{width:34px; height:34px; border-radius:50%; border:1px solid var(--stroke); object-fit:cover}
  .link{color:var(--ink); text-decoration:none; font-weight:700; border-bottom:1px dashed rgba(255,255,255,.35)}

  .links{display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:18px}
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:10px; padding:14px 18px; border-radius:12px;
       border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
       color:var(--ink); text-decoration:none; font-weight:700; letter-spacing:.2px; transition:transform .15s ease, box-shadow .15s ease; cursor:pointer}
  .btn:hover{transform:translateY(-1px); box-shadow:0 8px 22px rgba(0,0,0,.35)}
  .btn.ghost{background:transparent}
  .btn.primary{border-color:rgba(122,162,255,.45); box-shadow: inset 0 0 0 1px rgba(122,162,255,.45)}
  .btn.danger{border-color:rgba(255,107,107,.45); box-shadow: inset 0 0 0 1px rgba(255,107,107,.45)}

  footer{margin-top:28px; text-align:center; color:var(--muted); font-size:14px}

  /* Оверлей/панель «Библиолетка» */
  .overlay{position:fixed; inset:0; display:none; z-index:9999; background:rgba(5,8,20,.85); backdrop-filter:blur(6px)}
  .overlay.open{display:grid; place-items:center}
  .panel{width:min(1100px,96vw); height:min(85vh,900px); background:rgba(255,255,255,.06); border:1px solid var(--stroke); border-radius:18px; overflow:hidden; display:grid; grid-template-rows:auto 1fr}
  .panel-header{display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid var(--stroke); background:rgba(13,19,40,.9)}
  .back-btn{display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--ink); font-weight:700; cursor:pointer}
  .panel-title{font-weight:800}
  .panel-tabs{margin-left:auto; display:flex; gap:8px}
  .panel-tab{padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); cursor:pointer; font-weight:700}
  .panel-tab.active{outline:2px solid rgba(122,162,255,.55)}
  .panel-body{position:relative}
  .tab{position:absolute; inset:0; overflow:auto; padding:14px; display:none}
  .tab.active{display:block}

  /* Галерея */
  .gallery-toolbar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:12px}
  .rules{font-size:14px; color:var(--muted)}
  .grid{display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:12px}
  .card{position:relative; border:1px solid var(--stroke); border-radius:14px; overflow:hidden; background:rgba(0,0,0,.25)}
  .card img{width:100%; height:160px; object-fit:cover; display:block}
  .card .meta{padding:8px 10px; display:flex; align-items:center; justify-content:space-between; gap:8px}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.14); font-size:12px}
  .badge.pending{border-color:rgba(255,193,7,.45)}
  .badge.like{border-color:rgba(122,162,255,.45)}
  .clickable{cursor:pointer}

  /* Деталка фото */
  .photo-view{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; height:100%;}
  .photo-img{width:100%; height:100%; object-fit:contain; background:rgba(0,0,0,.2); border:1px solid var(--stroke); border-radius:12px}
  .photo-side{display:flex; flex-direction:column; gap:10px}
  .comments{flex:1; overflow:auto; border:1px solid var(--stroke); border-radius:12px; padding:8px; background:rgba(0,0,0,.2)}
  .comment{border-bottom:1px dashed rgba(255,255,255,.15); padding:6px 0}
  .comment:last-child{border-bottom:none}

  /* Модалки (вход/регистрация/профиль/загрузка/фото) */
  .modal{position:fixed; inset:0; display:none; background:rgba(5,8,20,.85); z-index:10000; place-items:center; backdrop-filter: blur(6px)}
  .modal.open{display:grid}
  .sheet{width:min(520px,95vw); background:rgba(255,255,255,.06); border:1px solid var(--stroke); border-radius:18px; overflow:hidden}
  .sheet-header{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--stroke); background:rgba(13,19,40,.9)}
  .sheet-title{font-weight:800}
  .sheet-body{padding:14px; display:grid; gap:10px}
  .field{display:grid; gap:6px}
  .input, .file{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.18); background:rgba(0,0,0,.25); color:var(--ink)}
  .hint{font-size:12px; color:var(--muted)}
  .actions{display:flex; gap:8px; justify-content:flex-end}
  .tabsline{display:flex; gap:8px}
  .tabsline .btn.active{outline:2px solid rgba(122,162,255,.55)}

  /* Профиль */
  .profile-row{display:flex; align-items:center; gap:12px}
  .profile-avatar{width:64px; height:64px; border-radius:50%; border:1px solid var(--stroke); object-fit:cover}

  /* Спрятать элементы когда не нужно */
  .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="topbar">
        <div class="tabs" aria-label="Навигация">
          <button class="tablink" id="open-gallery" type="button">Библиолетка</button>
          <button class="tablink" id="open-tiktok" type="button">Библиолетка TikTok</button>
        </div>
        <div class="authbox" id="authbox">
          <button class="btn" id="open-login">Войти / Регистрация</button>
        </div>
      </div>
      <h1>Вайб 2021</h1>
      <p class="greeting">Всем привет ребята! Это сайт моего канала — тут в принципе тот самый вайб 2021 года...
Время идёт очень быстро — с 01.01.2021 прошло <strong><span id="days-inline">0</span></strong> дней.
Сейчас <strong><span id="current-year"></span></strong> год.
Хочу для вас оставить ссылки на свои каналы (YouTube и т. д.). Уже нет того вайба, который был в те годы —
2021 год остался в наших хороших воспоминаниях Или всё ещё есть шанс восстановить эти годы? Давайте все вместе попробуем!
Весь TikTok уже пытается. Если хотите присоединиться к нам, просто нажмите «Перейти на канал» — тогда вы автоматически становитесь участником восстановления 2021 года.

Необязательно! Если хотите, можете зайти на канал и всё равно не будете участником, если так пожелаете. Внизу — кнопка перехода на мой канал.</p>
      <div class="counter">
        <div class="pill"><strong id="days-since">0</strong> дней с 01.01.2021</div>
        <div class="pill">Сегодня: <span id="today"></span></div>
      </div>
    </header>

    <section class="links" aria-label="Мои ссылки">
      <a class="btn" href="https://www.youtube.com/@Promo15_Official" target="_blank" rel="noopener">Перейти на канал</a>
      <a class="btn" href="https://www.tiktok.com/@richardbabayan0" target="_blank" rel="noopener">Перейти в TikTok</a>
    </section>

    <footer>© <span id="year"></span> Promo15_Official</footer>
  </div>

  <!-- Оверлей: «Библиолетка» (галерея + TikTok) -->
  <div class="overlay" id="library" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="panel-title">
      <div class="panel-header">
        <button class="back-btn" id="panel-close" aria-label="Назад">← Назад</button>
        <div class="panel-title" id="panel-title">Библиолетка</div>
        <div class="panel-tabs">
          <button class="panel-tab active" data-tab="gallery">Библиолетка</button>
          <button class="panel-tab" data-tab="tiktok">Библиолетка TikTok</button>
        </div>
      </div>
      <div class="panel-body">
        <!-- TAB: Галерея -->
        <div id="tab-gallery" class="tab active" role="region" aria-label="Галерея фото">
          <div class="gallery-toolbar">
            <div class="rules">Категория: «вайб зимы 2021». Нельзя выкладывать запрещённый контент. Все фото проверяются модератором.</div>
            <button class="btn primary" id="add-photo">✚ Добавить фото</button>
          </div>
          <div id="gallery-grid" class="grid" aria-live="polite"></div>
        </div>

        <!-- TAB: TikTok -->
        <div id="tab-tiktok" class="tab" role="region" aria-label="TikTok поиск">
          <iframe id="tiktok-iframe" title="TikTok Search"
            loading="lazy"
            class="tiktok-frame" style="position:absolute; inset:0; width:100%; height:100%; border:0; background:rgba(0,0,0,.2)"
            referrerpolicy="no-referrer"
            sandbox="allow-scripts allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
          <div id="tiktok-fallback" class="sheet-body" style="position:absolute; inset:0; display:none; place-items:center; text-align:center">
            <div style="max-width:560px; margin:auto">
              <h3>Открыть видео в TikTok</h3>
              <p class="rules">Похоже, TikTok запрещает встраивание поиска в другие сайты. Откройте все видео по запросу «вайб 2021 год» в новой вкладке.</p>
              <a class="btn" href="https://www.tiktok.com/search?q=%D0%B2%D0%B0%D0%B9%D0%B1%202021%20%D0%B3%D0%BE%D0%B4" target="_blank" rel="noopener">Открыть поиск на TikTok</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модалка: Загрузка фото -->
  <div class="modal" id="upload-modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="upload-title">
      <div class="sheet-header">
        <div class="sheet-title" id="upload-title">Загрузить фото</div>
        <button class="back-btn" id="upload-close">← Назад</button>
      </div>
      <form class="sheet-body" id="upload-form">
        <div class="field">
          <div class="rules"><strong>Внимание!</strong> Фото должно соответствовать теме «вайб зимы 2021». Запрещён контент, нарушающий правила. Все фото проверяются модератором до публикации.</div>
        </div>
        <div class="field">
          <label for="photo-title">Название</label>
          <input id="photo-title" class="input" type="text" maxlength="80" placeholder="Например: Снежный двор 2021" required />
        </div>
        <div class="field">
          <label for="photo-file">Фотография (1 файл, JPG/PNG, до 8 МБ)</label>
          <input id="photo-file" class="file" type="file" accept="image/*" required />
          <div class="hint">После модерации фото станет видно всем.</div>
        </div>
        <div class="actions">
          <button class="btn" type="button" id="upload-cancel">Отмена</button>
          <button class="btn primary" type="submit">Выложить</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Модалка: Просмотр фото -->
  <div class="modal" id="photo-modal" aria-hidden="true">
    <div class="sheet" style="width:min(1100px,96vw)" role="dialog" aria-modal="true" aria-labelledby="photo-title-h">
      <div class="sheet-header">
        <div class="sheet-title" id="photo-title-h">Фото</div>
        <button class="back-btn" id="photo-close">← Назад</button>
      </div>
      <div class="sheet-body" style="height:min(70vh,720px)">
        <div class="photo-view">
          <img id="pv-img" class="photo-img" alt="Просмотр фото" />
          <div class="photo-side">
            <div id="pv-meta"></div>
            <div class="actions">
              <button class="btn" id="pv-like">❤ Лайк <span id="pv-like-count" class="badge like">0</span></button>
              <button class="btn danger hidden" id="pv-delete">Удалить фото</button>
            </div>
            <div class="comments" id="pv-comments"></div>
            <form id="pv-comment-form" class="field">
              <label for="pv-comment-input">Комментарий</label>
              <input id="pv-comment-input" class="input" type="text" maxlength="300" placeholder="Напишите что-нибудь..." />
              <div class="actions"><button class="btn primary" type="submit">Отправить</button></div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модалка: Вход/Регистрация -->
  <div class="modal" id="auth-modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="auth-title">
      <div class="sheet-header">
        <div class="sheet-title" id="auth-title">Вход и регистрация</div>
        <button class="back-btn" id="auth-close">← Назад</button>
      </div>
      <div class="sheet-body">
        <div class="tabsline">
          <button class="btn active" id="tab-login">Вход</button>
          <button class="btn" id="tab-register">Регистрация</button>
        </div>
        <form id="login-form" class="field">
          <label for="login-email">Email</label>
          <input id="login-email" class="input" type="email" autocomplete="email" required />
          <label for="login-password">Пароль</label>
          <input id="login-password" class="input" type="password" autocomplete="current-password" required />
          <div class="actions">
            <button class="btn" type="button" id="google-login">Войти через Google</button>
            <button class="btn primary" type="submit">Войти</button>
          </div>
        </form>
        <form id="register-form" class="field hidden">
          <label for="reg-display">Имя (отображается)</label>
          <input id="reg-display" class="input" type="text" maxlength="40" placeholder="Ваш ник" />
          <label for="reg-email">Email</label>
          <input id="reg-email" class="input" type="email" autocomplete="email" required />
          <label for="reg-password">Пароль</label>
          <input id="reg-password" class="input" type="password" minlength="8" autocomplete="new-password" required />
          <label for="reg-password2">Повтор пароля</label>
          <input id="reg-password2" class="input" type="password" minlength="8" autocomplete="new-password" required />
          <div class="hint">Пароль хранится и проверяется на стороне безопасного провайдера, мы не видим ваш пароль. Не делитесь им с третьими лицами.</div>
          <div class="actions">
            <button class="btn" type="button" id="google-register">Google</button>
            <button class="btn primary" type="submit">Зарегистрироваться</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Модалка: Профиль -->
  <div class="modal" id="profile-modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="profile-title">
      <div class="sheet-header">
        <div class="sheet-title" id="profile-title">Мой профиль</div>
        <button class="back-btn" id="profile-close">← Назад</button>
      </div>
      <div class="sheet-body">
        <div class="profile-row">
          <img id="prof-avatar" class="profile-avatar" alt="Аватар" />
          <div>
            <div id="prof-name" style="font-weight:800"></div>
            <div id="prof-email" class="rules"></div>
          </div>
        </div>
        <div class="field">
          <label for="prof-avatar-file">Сменить аватар</label>
          <input id="prof-avatar-file" class="file" type="file" accept="image/*" />
          <div class="hint">JPG/PNG до 5 МБ. Совет: квадратная картинка 512×512.</div>
        </div>
        <div class="actions">
          <button class="btn" id="to-my-photos">Мои фото</button>
          <button class="btn danger" id="logout">Выйти</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // ===== Таймер дней с 01.01.2021 =====
  (function(){
    function calcDaysSince2021(){
      const startUTC = Date.UTC(2021, 0, 1);
      const now = new Date();
      const todayUTC = Date.UTC(now.getFullYear(), now.getMonth(), now.getDate());
      const days = Math.floor((todayUTC - startUTC) / 86400000);
      const daysStr = days.toLocaleString('ru-RU');
      const todayStr = now.toLocaleDateString('ru-RU', {year:'numeric', month:'long', day:'numeric'});
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      set('days-since', daysStr);
      set('days-inline', daysStr);
      set('today', todayStr);
      set('current-year', now.getFullYear());
      set('year', now.getFullYear());
    }
    calcDaysSince2021();
    setInterval(calcDaysSince2021, 60000);
  })();
  </script>

  <!--
  =======================
  Firebase подключение
  =======================
  1) Создай проект в Firebase, включи Authentication (Email/Password + Google), Firestore и Storage.
  2) Подставь свой firebaseConfig ниже.
  3) Настрой правила безопасности (см. блок правил внизу файла — внутри HTML-комментария).
  -->

  <script type="module">
  // ---- Импорты Firebase (версию можно обновить при необходимости) ----
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, 
           signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, 
           signOut, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, collection, addDoc, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, 
           serverTimestamp, query, orderBy, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

  // ---- ТВОЯ КОНФИГУРАЦИЯ (ЗАМЕНИ НА СВОЮ) ----
  const firebaseConfig = {
    apiKey: "AIzaSyCTbrBE04f9s85V5vF565b1J89htP-QjWE",
    authDomain: "shlepa-f7e06.firebaseapp.com",
    projectId: "shlepa-f7e06",
    storageBucket: "shlepa-f7e06.firebasestorage.app",
    messagingSenderId: "453452313107",
    appId: "1:453452313107:web:c3a63a4de656e07df605e6"
  };

  // Админы модерации (разрешено подтверждать фото approved=true)
  const ADMIN_UIDS = YENSqygLKrQ4PMMbcEG4109jSST2 [
    // 'UID_СЮДА' 
  ];

  // ---- Инициализация ----
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);
  setPersistence(auth, browserLocalPersistence);

  // ---- Утилиты ----
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const fmtDate = (ts) => {
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    return d.toLocaleString('ru-RU');
  };
  const isAdmin = (uid) => ADMIN_UIDS.includes(uid);

  // ---- Элементы UI ----
  const authbox = $('#authbox');
  const openLoginBtn = $('#open-login');
  const profileModal = $('#profile-modal');
  const authModal = $('#auth-modal');
  const uploadModal = $('#upload-modal');
  const library = $('#library');

  // Панель «Библиолетка»
  const openGalleryBtn = $('#open-gallery');
  const openTiktokBtn = $('#open-tiktok');
  const panelClose = $('#panel-close');
  const panelTabs = $$('.panel-tab');
  const tabGallery = $('#tab-gallery');
  const tabTiktok = $('#tab-tiktok');
  const tiktokIframe = $('#tiktok-iframe');
  const tiktokFallback = $('#tiktok-fallback');
  const TIKTOK_URL = 'https://www.tiktok.com/search?q=%D0%B2%D0%B0%D0%B9%D0%B1%202021%20%D0%B3%D0%BE%D0%B4';

  // Галерея
  const addPhotoBtn = $('#add-photo');
  const galleryGrid = $('#gallery-grid');

  // Модалка загрузки
  const uploadClose = $('#upload-close');
  const uploadCancel = $('#upload-cancel');
  const uploadForm = $('#upload-form');
  const photoTitleInput = $('#photo-title');
  const photoFileInput = $('#photo-file');

  // Модалка фото
  const photoModal = $('#photo-modal');
  const photoClose = $('#photo-close');
  const pvImg = $('#pv-img');
  const pvMeta = $('#pv-meta');
  const pvLike = $('#pv-like');
  const pvLikeCount = $('#pv-like-count');
  const pvDelete = $('#pv-delete');
  const pvComments = $('#pv-comments');
  const pvCommentForm = $('#pv-comment-form');
  const pvCommentInput = $('#pv-comment-input');

  // Модалка авторизации
  const authClose = $('#auth-close');
  const tabLogin = $('#tab-login');
  const tabRegister = $('#tab-register');
  const loginForm = $('#login-form');
  const registerForm = $('#register-form');
  const googleLogin = $('#google-login');
  const googleRegister = $('#google-register');

  // Профиль
  const profileClose = $('#profile-close');
  const profAvatar = $('#prof-avatar');
  const profName = $('#prof-name');
  const profEmail = $('#prof-email');
  const profAvatarFile = $('#prof-avatar-file');
  const toMyPhotos = $('#to-my-photos');
  const logoutBtn = $('#logout');

  // Состояние
  let currentUser = null;
  let unsubPhotos = null; // отписка от подписки на галерею
  let openPhotoId = null; // id открытого фото
  let unsubComments = null; // отписка комментариев
  let unsubLikes = null; // отписка лайков

  // ---- Навигация и модалки ----
  function openModal(el){ el.classList.add('open'); el.setAttribute('aria-hidden','false'); }
  function closeModal(el){ el.classList.remove('open'); el.setAttribute('aria-hidden','true'); }
  function openLibrary(tab='gallery'){
    openTab(tab);
    openModal(library);
    if (tab === 'tiktok') ensureTikTok();
  }
  function closeLibrary(){ closeModal(library); }

  function openTab(tab){
    panelTabs.forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
    tabGallery.classList.toggle('active', tab === 'gallery');
    tabTiktok.classList.toggle('active', tab === 'tiktok');
  }
  function ensureTikTok(){
    tiktokFallback.style.display = 'none';
    tiktokIframe.src = TIKTOK_URL;
    setTimeout(()=>{ tiktokFallback.style.display = 'grid'; }, 2500);
  }

  openGalleryBtn.addEventListener('click', () => openLibrary('gallery'));
  openTiktokBtn.addEventListener('click', () => openLibrary('tiktok'));
  panelClose.addEventListener('click', closeLibrary);
  panelTabs.forEach(btn => btn.addEventListener('click', () => {
    const tab = btn.dataset.tab; openTab(tab); if (tab==='tiktok') ensureTikTok();
  }));

  // Кнопки добавления фото / загрузка
  addPhotoBtn.addEventListener('click', () => {
    if (!currentUser) { openAuth(); return; }
    photoTitleInput.value = '';
    photoFileInput.value = '';
    openModal(uploadModal);
  });
  uploadClose.addEventListener('click', () => closeModal(uploadModal));
  uploadCancel.addEventListener('click', () => closeModal(uploadModal));

  // Открытие/закрытие фото
  photoClose.addEventListener('click', () => {
    if (unsubComments) unsubComments();
    if (unsubLikes) unsubLikes();
    openPhotoId = null; pvImg.src = ''; pvMeta.innerHTML = ''; pvComments.innerHTML='';
    closeModal(photoModal);
  });

  // Авторизация модалка
  function openAuth(){ openModal(authModal); }
  openLoginBtn?.addEventListener('click', openAuth);
  authClose.addEventListener('click', ()=> closeModal(authModal));
  tabLogin.addEventListener('click', () => { tabLogin.classList.add('active'); tabRegister.classList.remove('active'); loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); });
  tabRegister.addEventListener('click', () => { tabRegister.classList.add('active'); tabLogin.classList.remove('active'); registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); });

  // Профиль
  function openProfile(){ if (!currentUser) return; openModal(profileModal); renderProfile(); }
  profileClose.addEventListener('click', ()=> closeModal(profileModal));
  logoutBtn.addEventListener('click', async () => { await signOut(auth); closeModal(profileModal); });

  // ---- Аутентификация ----
  const provider = new GoogleAuthProvider();
  googleLogin.addEventListener('click', async () => { try{ await signInWithPopup(auth, provider); closeModal(authModal); }catch(e){ alert('Ошибка Google входа: '+e.message); }});
  googleRegister.addEventListener('click', async () => { try{ await signInWithPopup(auth, provider); closeModal(authModal); }catch(e){ alert('Ошибка Google: '+e.message); }});

  loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = $('#login-email').value.trim();
    const pass = $('#login-password').value;
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      closeModal(authModal);
    }catch(err){ alert('Вход не выполнен: '+(err?.message||err)); }
  });

  registerForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const display = $('#reg-display').value.trim();
    const email = $('#reg-email').value.trim();
    const p1 = $('#reg-password').value; const p2 = $('#reg-password2').value;
    if (p1!==p2) { alert('Пароли не совпадают'); return; }
    try{
      const cred = await createUserWithEmailAndPassword(auth, email, p1);
      const user = cred.user;
      const newName = display || (email.split('@')[0]);
      await updateProfile(user, { displayName: newName });
      // создать документ профиля
      await setDoc(doc(db,'users', user.uid), {
        displayName: newName,
        email: user.email,
        photoURL: user.photoURL || '',
        createdAt: serverTimestamp()
      });
      closeModal(authModal);
    }catch(err){ alert('Регистрация не выполнена: '+(err?.message||err)); }
  });

  // ---- Состояние пользователя и отрисовка правого угла ----
  onAuthStateChanged(auth, async (user)=>{
    currentUser = user;
    if (user){
      // создать профиль, если нет
      const uref = doc(db,'users', user.uid);
      const udoc = await getDoc(uref);
      if (!udoc.exists()){
        await setDoc(uref, { displayName: user.displayName||'', email: user.email||'', photoURL: user.photoURL||'', createdAt: serverTimestamp() });
      }
      // Правый угол: аватар + Профиль
      authbox.innerHTML = '';
      const btn = document.createElement('button'); btn.className='btn ghost'; btn.id='open-profile';
      const img = document.createElement('img'); img.className='avatar'; img.id='mini-avatar'; img.alt='Аватар'; img.src=user.photoURL||'https://i.pravatar.cc/64?u='+user.uid;
      btn.appendChild(img); btn.appendChild(document.createTextNode(' Профиль'));
      btn.addEventListener('click', openProfile);
      authbox.appendChild(btn);
    } else {
      authbox.innerHTML = '';
      const btn = document.createElement('button'); btn.className='btn'; btn.id='open-login'; btn.textContent='Войти / Регистрация';
      btn.addEventListener('click', openAuth);
      authbox.appendChild(btn);
    }
  });

  // ---- Профиль: данные и смена аватара ----
  async function renderProfile(){
    if (!currentUser) return;
    profAvatar.src = currentUser.photoURL || 'https://i.pravatar.cc/128?u='+currentUser.uid;
    profName.textContent = currentUser.displayName || '(без имени)';
    profEmail.textContent = currentUser.email || '';
  }
  profAvatarFile.addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f || !currentUser) return;
    if (f.size > 5*1024*1024) { alert('Слишком большой файл (>5 МБ)'); return; }
    try{
      const r = sRef(storage, `avatars/${currentUser.uid}.jpg`);
      await uploadBytes(r, f);
      const url = await getDownloadURL(r);
      await updateProfile(currentUser, { photoURL: url });
      await updateDoc(doc(db,'users', currentUser.uid), { photoURL: url });
      const mini = $('#mini-avatar'); if (mini) mini.src = url;
      renderProfile();
      alert('Аватар обновлён!');
    }catch(err){ alert('Не удалось обновить аватар: '+(err?.message||err)); }
  });

  // ---- Загрузка фото ----
  uploadForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!currentUser) { openAuth(); return; }
    const title = photoTitleInput.value.trim();
    const file = photoFileInput.files?.[0];
    if (!file) { alert('Прикрепите фото'); return; }
    if (!/^image\//.test(file.type)) { alert('Можно только изображения'); return; }
    if (file.size > 8*1024*1024){ alert('Файл больше 8 МБ'); return; }
    try{
      const path = `photos/${currentUser.uid}/${Date.now()}_${file.name.replace(/[^a-z0-9_.-]+/gi,'_')}`;
      const r = sRef(storage, path);
      await uploadBytes(r, file);
      const url = await getDownloadURL(r);
      const docRef = await addDoc(collection(db,'photos'), {
        title,
        imageURL: url,
        storagePath: path,
        ownerUid: currentUser.uid,
        ownerName: currentUser.displayName || 'Без имени',
        ownerPhoto: currentUser.photoURL || '',
        createdAt: serverTimestamp(),
        approved: false // модерация
      });
      closeModal(uploadModal);
      alert('Фото отправлено на модерацию!');
    }catch(err){ alert('Загрузка не удалась: '+(err?.message||err)); }
  });

  // ---- Подписка на галерею ----
  function listenGallery(myOnly=false){
    if (unsubPhotos) unsubPhotos();
    galleryGrid.innerHTML = '<div class="rules">Загрузка...</div>';
    let q = query(collection(db,'photos'), orderBy('createdAt','desc'));
    if (myOnly && currentUser) {
      q = query(collection(db,'photos'), where('ownerUid','==', currentUser.uid), orderBy('createdAt','desc'));
    } else {
      q = query(collection(db,'photos'), where('approved','==', true), orderBy('createdAt','desc'));
    }
    unsubPhotos = onSnapshot(q, (snap)=>{
      galleryGrid.innerHTML = '';
      if (snap.empty){ galleryGrid.innerHTML = '<div class="rules">Пока пусто.</div>'; return; }
      snap.forEach(docu => {
        const d = docu.data();
        const card = document.createElement('div'); card.className='card clickable'; card.dataset.id = docu.id;
        const img = document.createElement('img'); img.src = d.imageURL; img.alt = d.title || 'Фото';
        const meta = document.createElement('div'); meta.className='meta';
        const left = document.createElement('div'); left.innerHTML = `<strong>${(d.title||'Без названия')}</strong><br><span class="rules">${(d.ownerName||'')}</span>`;
        const right = document.createElement('div');
        if (d.approved!==true) {
          const b = document.createElement('span'); b.className='badge pending'; b.textContent='На модерации'; right.appendChild(b);
        }
        meta.appendChild(left); meta.appendChild(right);
        card.appendChild(img); card.appendChild(meta);
        card.addEventListener('click', ()=> openPhoto(docu.id, d));
        galleryGrid.appendChild(card);
      });
    }, (err)=>{
      console.error(err); galleryGrid.innerHTML = '<div class="rules">Ошибка загрузки галереи.</div>';
    });
  }
  // По умолчанию — общая лента (approved)
  listenGallery(false);

  // Мои фото из профиля
  toMyPhotos.addEventListener('click', ()=>{ closeModal(profileModal); openLibrary('gallery'); listenGallery(true); });

  // ---- Просмотр фото + лайки + комментарии ----
  async function openPhoto(id, data){
    openPhotoId = id;
    pvImg.src = data.imageURL; $('#photo-title-h').textContent = data.title || 'Фото';
    const metaHtml = `
      <div><strong>${data.title||'Без названия'}</strong></div>
      <div class="rules">Автор: ${(data.ownerName||'Неизвестно')}</div>
      <div class="rules">Создано: ${(data.createdAt?fmtDate(data.createdAt):'…')}</div>
    `;
    pvMeta.innerHTML = metaHtml;
    pvDelete.classList.toggle('hidden', !currentUser || currentUser.uid!==data.ownerUid);

    // Подписка на лайки
    if (unsubLikes) unsubLikes();
    const likesCol = collection(db,'photos', id, 'likes');
    unsubLikes = onSnapshot(likesCol, (likeSnap)=>{
      pvLikeCount.textContent = likeSnap.size;
    });

    // При нажатии лайк
    pvLike.onclick = async () => {
      if (!currentUser) { openAuth(); return; }
      const likeDoc = doc(db,'photos', id, 'likes', currentUser.uid);
      const got = await getDoc(likeDoc);
      if (got.exists()) {
        await deleteDoc(likeDoc);
      } else {
        await setDoc(likeDoc, { uid: currentUser.uid, at: serverTimestamp() });
      }
    };

    // Комментарии
    if (unsubComments) unsubComments();
    const commCol = collection(db,'photos', id, 'comments');
    unsubComments = onSnapshot(query(commCol, orderBy('at','asc')), (snap)=>{
      pvComments.innerHTML = '';
      if (snap.empty){ pvComments.innerHTML = '<div class="rules">Комментариев пока нет.</div>'; return; }
      snap.forEach(c=>{
        const cd = c.data();
        const el = document.createElement('div'); el.className='comment';
        el.innerHTML = `<div><strong>${cd.authorName||'Аноним'}</strong> <span class="rules">${fmtDate(cd.at)}</span></div><div>${(cd.text||'')}</div>`;
        pvComments.appendChild(el);
      });
    });

    pvCommentForm.onsubmit = async (e)=>{
      e.preventDefault(); if (!currentUser) { openAuth(); return; }
      const text = pvCommentInput.value.trim(); if (!text) return;
      try{
        await addDoc(collection(db,'photos', id, 'comments'), {
          text,
          authorUid: currentUser.uid,
          authorName: currentUser.displayName || 'Без имени',
          at: serverTimestamp()
        });
        pvCommentInput.value='';
      }catch(err){ alert('Не удалось отправить: '+(err?.message||err)); }
    };

    pvDelete.onclick = async () => {
      if (!currentUser || currentUser.uid!==data.ownerUid) return;
      if (!confirm('Удалить это фото?')) return;
      try{
        // Удалить подписи (комменты, лайки)
        const likesQ = await getDocs(collection(db,'photos', id, 'likes'));
        for (const d of likesQ.docs) await deleteDoc(d.ref);
        const commQ = await getDocs(collection(db,'photos', id, 'comments'));
        for (const d of commQ.docs) await deleteDoc(d.ref);
        // Удалить сам документ фото
        await deleteDoc(doc(db,'photos', id));
        alert('Фото удалено');
        photoClose.click();
      }catch(err){ alert('Не удалось удалить: '+(err?.message||err)); }
    };

    openModal(photoModal);
  }

  // ---- Клавиша Esc и клик по фону (закрытие модалок) ----
  window.addEventListener('keydown', (e)=>{
    if (e.key==='Escape') {
      [library, uploadModal, photoModal, authModal, profileModal].forEach(m => m.classList.contains('open') && closeModal(m));
    }
  });
  [library, uploadModal, photoModal, authModal, profileModal].forEach(mod => {
    mod.addEventListener('click', (e)=>{ if (e.target===mod) closeModal(mod); });
  });

  // ---- При первом открытии библиотек по умолчанию — общая лента ----
  // уже вызвали listenGallery(false) выше

  </script>

  <!--
  =======================
  Firestore и Storage Rules (СКОПИРУЙ в консоль Firebase => Rules)
  =======================
  // Firestore rules (пример, адаптируй под свой проект):
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      function isSignedIn() { return request.auth != null; }
      function isOwner(ownerUid) { return isSignedIn() && request.auth.uid == ownerUid; }
      function isAdmin() { return isSignedIn() && request.auth.uid in [
        // 'UID_СЮДА'
      ]; }

      match /users/{uid} {
        allow read: if isSignedIn();
        allow write: if isOwner(uid);
      }

      match /photos/{photoId} {
        allow create: if isSignedIn() && request.resource.data.ownerUid == request.auth.uid;
        allow read: if resource.data.approved == true || isOwner(resource.data.ownerUid) || isAdmin();
        // Владелец может удалять только своё фото
        allow delete: if isOwner(resource.data.ownerUid) || isAdmin();
        // Админ может подтверждать модерацию
        allow update: if isAdmin();

        // Подколлекции
        match /comments/{cid} {
          allow read: if exists(/databases/$(database)/documents/photos/$(photoId)) &&
                         (get(/databases/$(database)/documents/photos/$(photoId)).data.approved == true || isOwner(get(/databases/$(database)/documents/photos/$(photoId)).data.ownerUid) || isAdmin());
          allow create: if isSignedIn() && request.resource.data.authorUid == request.auth.uid;
          allow delete: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.authorUid);
          allow update: if false; // не редактируем
        }
        match /likes/{uid} {
          allow read: if true; // лайки видны всем
          allow create, update, delete: if isSignedIn() && request.auth.uid == uid;
        }
      }
    }
  }

  // Storage rules (пример):
  rules_version = '2';
  service firebase.storage {
    match /b/{bucket}/o {
      function isSignedIn() { return request.auth != null; }
      match /avatars/{uid}.jpg {
        allow read: if true;
        allow write: if isSignedIn() && request.auth.uid == uid;
      }
      match /photos/{uid}/{allPaths=**} {
        allow read: if true; // сами файлы можно читать
        allow write: if isSignedIn() && request.auth.uid == uid;
      }
    }
  }
  -->
</body>
</html>
